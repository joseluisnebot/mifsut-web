<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MIFSUT – Admin</title>

    <!-- Decap: ruta del config -->
    <script>window.CMS_CONFIG_PATH = "/admin/config.yml";</script>

    <!-- SHIM: 1) Captura postMessage  2) Lee token del hash y lo guarda -->
    <script>
      (function () {
        function saveToken(token) {
          if (!token) return;
          try {
            const user = { token, provider: "github" };
            localStorage.setItem("netlify-cms-user", JSON.stringify(user));
            // Entrar al panel
            location.replace("/admin/index.html#/");
          } catch (_) {}
        }

        // 1) postMessage: string "authorization:github:success:<token>" o objeto {token}
        function onMsg(ev) {
          try {
            const d = ev.data;
            if (typeof d === "string" && d.startsWith("authorization:github:success:")) {
              return saveToken(d.split(":").pop());
            }
            if (d && typeof d === "object" && "token" in d) {
              return saveToken(d.token);
            }
          } catch (_) {}
        }
        window.addEventListener("message", onMsg, false);

        // 2) Hash en la URL: /admin/index.html#/<encoded("authorization:github:success:<token>")>
        (function readHash() {
          try {
            const h = location.hash || "";
            if (!h) return;
            // ejemplos: "#/authorization%3Agithub%3Asuccess%3A<token>", "#authorization:github:success:<token>"
            const raw = decodeURIComponent(h.replace(/^#\/?/, ""));
            if (raw.startsWith("authorization:github:success:")) {
              return saveToken(raw.split(":").pop());
            }
          } catch (_) {}
        })();
      })();
    </script>

    <!-- Carga Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.3.0/dist/decap-cms.js" defer></script>

    <style>
      html,body{height:100%;margin:0;background:#0b0f14;color:#e6edf3;}
      #boot{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:.7}
    </style>
  </head>
  <body>
    <div id="boot">Cargando panel…</div>
    <noscript>Necesitas habilitar JavaScript para usar el panel.</noscript>
  </body>
</html>
